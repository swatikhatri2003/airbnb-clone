<% layout("/layouts/boilerplate") %>

<div class="show-page">
  <div class="show-title-row">
    <a href="/listings" class="show-back-btn" aria-label="Back to listings">
      <i class="fa-solid fa-arrow-left"></i>
    </a>
    <h1 class="show-title"><%= listing.title %></h1>
  </div>
  <p class="show-meta">Hosted by <strong><%= listing.owner.username %></strong></p>

  <div class="show-img-wrap">
    <% if (listing.image && listing.image.url) { %>
      <img src="<%= listing.image.url %>" alt="<%= listing.title %>">
    <% } else { %>
      <img src="https://images.unsplash.com/photo-1566073771259-6a8506099945?w=1200" alt="<%= listing.title %>">
    <% } %>
  </div>

  <div class="show-details">
    <p class="mb-0"><strong>&#8377;<%= (listing.price || 0).toLocaleString('en-IN') %></strong> per night</p>
    <p class="mb-0"><%= listing.location %>, <%= listing.country %></p>
  </div>

  <p class="show-description"><%= listing.description %></p>

  <% if (currUser && String(listing.owner._id) === String(currUser._id)) { %>
    <div class="show-actions">
      <a href="/listings/<%= listing._id %>/edit" class="btn-primary-app">Edit listing</a>
      <form action="/listings/<%= listing._id %>?_method=DELETE" method="POST" class="d-inline" onsubmit="return confirm('Delete this listing?');">
        <button type="submit" class="btn-outline-app">Delete</button>
      </form>
    </div>
  <% } %>

  <section class="reviews-section" aria-labelledby="review-heading">
    <h4 id="review-heading"><% if (!currUser) { %>Log in to <% } %>Leave a review</h4>

    <% if (currUser) { %>
      <div class="review-form-card">
        <form action="/listings/<%= listing._id %>/reviews" method="POST" novalidate class="needs-validation" id="reviewForm">
          <div class="star-rating-wrap">
            <span class="star-rating-label">Your rating</span>
            <input type="hidden" name="review[rating]" id="ratingInput" value="3" required>
            <div class="star-rating" id="starRating" role="group" aria-label="Rate 1 to 5 stars">
              <button type="button" class="star" data-value="1" aria-label="1 star"><i class="fa-regular fa-star"></i></button>
              <button type="button" class="star" data-value="2" aria-label="2 stars"><i class="fa-regular fa-star"></i></button>
              <button type="button" class="star" data-value="3" aria-label="3 stars"><i class="fa-regular fa-star"></i></button>
              <button type="button" class="star" data-value="4" aria-label="4 stars"><i class="fa-regular fa-star"></i></button>
              <button type="button" class="star" data-value="5" aria-label="5 stars"><i class="fa-regular fa-star"></i></button>
            </div>
            <span class="d-block mt-1 small text-muted" id="ratingLabel">3 out of 5</span>
          </div>
          <div class="form-group mb-3">
            <label for="comment">Comment</label>
            <textarea name="review[comment]" id="comment" class="form-control" rows="3" required placeholder="Share your experienceâ€¦"></textarea>
            <div class="invalid-feedback">Please enter a comment.</div>
          </div>
          <button type="submit" class="btn-primary-app">Submit review</button>
        </form>
      </div>
    <% } %>

    <% if (listing.reviews && listing.reviews.length > 0) { %>
      <h4 class="mt-4 mb-3">Reviews</h4>
      <div class="reviews-grid">
        <% for (let review of listing.reviews) { %>
          <div class="review-card">
            <div class="review-meta">
              <span class="review-author">@<%= review.author.username %></span>
              <span class="star-rating-display" aria-label="<%= review.rating %> out of 5 stars">
                <% for (let s = 1; s <= 5; s++) { %>
                  <% if (s <= review.rating) { %><i class="fa-solid fa-star star-full"></i><% } else { %><i class="fa-regular fa-star star-empty"></i><% } %>
                <% } %>
              </span>
            </div>
            <p class="review-comment"><%= review.comment %></p>
            <% if (currUser && String(review.author._id) === String(currUser._id)) { %>
              <form action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE" method="POST" class="d-inline mt-2" onsubmit="return confirm('Delete this review?');">
                <button type="submit" class="btn-outline-app btn-sm">Delete</button>
              </form>
            <% } %>
          </div>
        <% } %>
      </div>
    <% } else { %>
      <p class="text-muted mb-0">No reviews yet. Be the first to review!</p>
    <% } %>
  </section>
</div>

<script>
(function() {
  var container = document.getElementById('starRating');
  var input = document.getElementById('ratingInput');
  var label = document.getElementById('ratingLabel');
  if (!container || !input) return;

  var stars = container.querySelectorAll('.star');
  var current = parseInt(input.value, 10) || 3;

  function setFilled(upTo) {
    stars.forEach(function(star, i) {
      var val = i + 1;
      var icon = star.querySelector('i');
      if (icon) {
        icon.classList.remove('fa-regular', 'fa-solid');
        icon.classList.add(val <= upTo ? 'fa-solid' : 'fa-regular', 'fa-star');
      }
    });
  }

  function setHover(upTo) {
    if (upTo === 0) {
      setFilled(current);
      return;
    }
    stars.forEach(function(star, i) {
      var val = i + 1;
      var icon = star.querySelector('i');
      if (icon) {
        icon.classList.remove('fa-regular', 'fa-solid');
        icon.classList.add(val <= upTo ? 'fa-solid' : 'fa-regular', 'fa-star');
      }
    });
  }

  function updateLabel(val) {
    if (label) label.textContent = val + ' out of 5';
  }

  setFilled(current);

  stars.forEach(function(star) {
    var val = parseInt(star.getAttribute('data-value'), 10);

    star.addEventListener('click', function(e) {
      e.preventDefault();
      current = val;
      input.value = current;
      setFilled(current);
      updateLabel(current);
    });

    star.addEventListener('mouseenter', function() {
      setHover(val);
    });

    star.addEventListener('mouseleave', function() {
      setHover(0);
    });
  });
})();
</script>
