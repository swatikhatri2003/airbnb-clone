<% layout("/layouts/boilerplate") %>
<%
  const filterIcons = {
    "Trending": "fa-fire",
    "Rooms": "fa-bed",
    "Iconic Cities": "fa-mountain-city",
    "Mountains": "fa-mountain-sun",
    "Amazing Pools": "fa-person-swimming",
    "Camping": "fa-tents",
    "Farms": "fa-tractor",
    "Arctic": "fa-snowflake"
  };
  const catList = typeof categories !== 'undefined' && categories.length ? categories : Object.keys(filterIcons);
  function buildFilterUrl(cat) {
    const parts = [];
    if (typeof currentSearch !== 'undefined' && currentSearch) parts.push('search=' + encodeURIComponent(currentSearch));
    if (cat) parts.push('category=' + encodeURIComponent(cat));
    return '/listings' + (parts.length ? '?' + parts.join('&') : '');
  }
%>

<div class="filters-bar">
  <a href="<%= buildFilterUrl('') %>" class="filter-pill <%= (typeof currentCategory === 'undefined' || !currentCategory) ? 'active' : '' %>">
    <i class="fa-solid fa-fire"></i>
    <span>All</span>
  </a>
  <% for (const cat of catList) { if (cat === 'Trending') continue; %>
    <a href="<%= buildFilterUrl(cat) %>" class="filter-pill <%= (typeof currentCategory !== 'undefined' && currentCategory === cat) ? 'active' : '' %>">
      <i class="fa-solid <%= filterIcons[cat] || 'fa-tag' %>"></i>
      <span><%= cat %></span>
    </a>
  <% } %>
  <div class="tax-toggle-wrap">
    <div class="form-check form-switch mb-0">
      <input class="form-check-input" type="checkbox" id="taxSwitch" role="switch">
      <label class="form-check-label" for="taxSwitch">Show total before taxes</label>
    </div>
  </div>
</div>

<% if (alllistings && alllistings.length > 0) { %>
  <div class="listings-grid">
    <% for (let listing of alllistings) { %>
      <a href="/listings/<%= listing._id %>" class="listing-card-link listing-card-link">
        <article class="listing-card">
          <div class="card-img-wrap">
            <img src="<%= (listing.image && listing.image.url) ? listing.image.url : 'https://images.unsplash.com/photo-1566073771259-6a8506099945?w=800' %>" alt="<%= listing.title %>">
          </div>
          <div class="card-body">
            <h2 class="card-title"><%= listing.title %></h2>
            <p class="card-price">
              <strong>&#8377;<%= (listing.price || 0).toLocaleString('en-IN') %></strong> / night
              <span class="tax-info" aria-hidden="true"> &nbsp;+ 18% GST</span>
            </p>
          </div>
        </article>
      </a>
    <% } %>
  </div>
<% } else { %>
  <div class="no-results">
    <div class="no-results-icon"><i class="fa-solid fa-magnifying-glass"></i></div>
    <h3>No listings found</h3>
    <p>Try adjusting your search or filters to find what you're looking for.</p>
    <a href="/listings" class="btn-primary-app">View all listings</a>
  </div>
<% } %>

<script>
  (function() {
    var taxSwitch = document.getElementById('taxSwitch');
    if (taxSwitch) {
      function updateTaxVisibility() {
        var show = taxSwitch.checked;
        document.querySelectorAll('.tax-info').forEach(function(el) {
          el.classList.toggle('is-visible', show);
        });
      }
      taxSwitch.addEventListener('change', updateTaxVisibility);
      updateTaxVisibility();
    }
  })();
</script>
